#!/bin/bash
# =============================================================================
# Git Commit Message Hook
# =============================================================================
#
# Validates commit messages follow conventional format:
#   - Subject line: max 72 characters
#   - Type prefix required: feat, fix, docs, style, refactor, test, chore
#   - Optional scope in parentheses: feat(parser): description
#   - Body (if present): wrapped at 72 characters
#
# Installation:
#   cp scripts/hooks/commit-msg .git/hooks/commit-msg
#   chmod +x .git/hooks/commit-msg
#
# Or use: ./scripts/install_hooks.sh
#
# Created: 2026-01-16 (Session 35)
# =============================================================================

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# =============================================================================
# Configuration
# =============================================================================
SUBJECT_MAX_LENGTH=72
BODY_MAX_LENGTH=72

# Valid type prefixes (conventional commits)
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# =============================================================================
# Extract subject line (first line)
# =============================================================================
SUBJECT=$(echo "$COMMIT_MSG" | head -1)
SUBJECT_LENGTH=${#SUBJECT}

# =============================================================================
# Validation
# =============================================================================
ERRORS=""

# 1. Check subject length
if [ "$SUBJECT_LENGTH" -gt "$SUBJECT_MAX_LENGTH" ]; then
    ERRORS="${ERRORS}\n  - Subject too long: $SUBJECT_LENGTH chars (max $SUBJECT_MAX_LENGTH)"
fi

# 2. Check type prefix
if ! echo "$SUBJECT" | grep -qE "^($VALID_TYPES)(\(.+\))?(!)?:"; then
    # Allow merge commits and revert commits
    if ! echo "$SUBJECT" | grep -qE "^(Merge|Revert|TASK-)"; then
        ERRORS="${ERRORS}\n  - Missing type prefix. Use: feat, fix, docs, style, refactor, perf, test, build, ci, chore"
        ERRORS="${ERRORS}\n    Example: feat(parser): add new feature"
    fi
fi

# 3. Check for capital letter after colon
if echo "$SUBJECT" | grep -qE "^($VALID_TYPES)(\(.+\))?(!)?:[[:space:]]*[A-Z]"; then
    : # This is actually conventional - no error
fi

# 4. Check for period at end of subject
if echo "$SUBJECT" | grep -qE "\.$"; then
    ERRORS="${ERRORS}\n  - Subject should not end with period"
fi

# 5. Check body line length (if body exists)
BODY=$(echo "$COMMIT_MSG" | tail -n +3)
if [ -n "$BODY" ]; then
    LINE_NUM=3
    while IFS= read -r line; do
        LINE_LENGTH=${#line}
        if [ "$LINE_LENGTH" -gt "$BODY_MAX_LENGTH" ]; then
            ERRORS="${ERRORS}\n  - Line $LINE_NUM too long: $LINE_LENGTH chars (max $BODY_MAX_LENGTH)"
        fi
        ((LINE_NUM++))
    done <<< "$BODY"
fi

# =============================================================================
# Result
# =============================================================================
if [ -n "$ERRORS" ]; then
    echo -e "${RED}âŒ Commit message validation failed:${NC}"
    echo -e "$ERRORS"
    echo ""
    echo -e "${YELLOW}Your message:${NC}"
    echo "  $SUBJECT"
    echo ""
    echo -e "${YELLOW}Format:${NC}"
    echo "  <type>(<scope>): <description>"
    echo ""
    echo -e "${YELLOW}Types:${NC} feat, fix, docs, style, refactor, perf, test, build, ci, chore"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat(api): add user authentication"
    echo "  fix: resolve memory leak in parser"
    echo "  docs: update installation guide"
    echo ""
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi

exit 0
