name: Cost Optimizer Static Analysis

on:
  push:
    branches: [ main, task/FIX-* ]
    paths:
      - 'streamlit_app/pages/02_*.py'
      - 'streamlit_app/utils/cost_optimizer_*.py'
      - 'scripts/check_cost_optimizer_issues.py'
      - '.github/workflows/cost-optimizer-analysis.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'streamlit_app/pages/02_*.py'
      - 'streamlit_app/utils/cost_optimizer_*.py'

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    name: Cost Optimizer Code Quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy bandit radon pylint streamlit pandas plotly

      - name: Run automated issue detection
        id: issue-check
        run: |
          echo "üîç Running automated issue detection..."
          python scripts/check_cost_optimizer_issues.py || echo "issues_found=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Type checking with mypy
        run: |
          echo "üîç Running mypy type checking..."
          python -m mypy streamlit_app/pages/02_*.py \
            --ignore-missing-imports \
            --no-strict-optional \
            --check-untyped-defs || true
        continue-on-error: true

      - name: Security check with bandit
        run: |
          echo "üîç Running bandit security scan..."
          python -m bandit -r streamlit_app/pages/02_*.py \
            streamlit_app/utils/cost_optimizer_*.py \
            -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            echo "üìä Bandit findings:"
            python -m bandit -r streamlit_app/pages/ -f screen || true
          fi
        continue-on-error: true

      - name: Complexity check with radon
        run: |
          echo "üîç Running radon complexity analysis..."
          echo "=== Cyclomatic Complexity ==="
          python -m radon cc streamlit_app/pages/02_*.py -a -nb || true
          echo ""
          echo "=== Maintainability Index ==="
          python -m radon mi streamlit_app/pages/02_*.py -nb || true
        continue-on-error: true

      - name: Code quality with pylint
        run: |
          echo "üîç Running pylint code quality check..."
          python -m pylint streamlit_app/pages/02_*.py \
            --disable=C0103,C0114,C0115,C0116 \
            --max-line-length=100 \
            --output-format=colorized || true
        continue-on-error: true

      - name: Summary
        run: |
          echo "================================"
          echo "Cost Optimizer Analysis Complete"
          echo "================================"
          echo ""
          echo "‚úÖ All static analysis checks completed"
          echo "üìã Review the output above for any issues"
          echo ""
          echo "Note: This is informational only - does not block PR"
          echo "See docs/_internal/COST_OPTIMIZER_FIX_PLAN.md for remediation"
