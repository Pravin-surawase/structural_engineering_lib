<html><head><meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-en-US.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Visual C++ 2022</title><meta name="Language" content="en-us" /><meta name="Microsoft.Help.Id" content="19ec34d0-117e-45f7-a3c4-73c6688d16cf" /><meta name="Description" content="This example was created and tested in Microsoft Visual C++ 2022." /><meta name="Microsoft.Help.ContentType" content="How To" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Help1.css" /></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">CSI API ETABS v1</div><div class="pageBody"><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn"><h1>Visual C++ 2022</h1></td></tr></table><span class="introStyle"></span> <div class="introduction"><p>
				This example was created and tested in Microsoft Visual C++ 2022.
			</p></div><div class="subSection"><ol><li><p>
							Create a C++ Windows Console application.
						</p></li><li><p>
							Locate the <strong>ETABSv1.tlb</strong></p><p>
							With the release of ETABS v22.0.0 , users will need to select the TLB file that
							corresponds to the bitness of their API client, e.g. 32-bit or 64-bit.
							To locate these files, the user should navigate to the directory where ETABS is installed.
							This is typically <strong>C:\Program Files\Computers and Structures\ETABS 22\</strong></p><p>
							Within this directory, the 32-bit library is found at <strong>NativeAPI\x86\ETABSv1.tlb</strong>
							The 64-bit library is found at <strong>NativeAPI\x64\ETABSv1.tlb</strong></p><p>
							Copy the 64-bit <strong>ETABSv1.tlb</strong> file from the installation folder to the project directory.
							It should be copied to the same level as your client application’s project file.
						</p></li><li><p>
							Open the .cpp file generated by the wizard by double-clicking on it
							and paste in the following ready-to-run code:
						</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAABGAAA_tab1" class="codeSnippetContainerTabSingle">C++</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAABGAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAABGAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAABGAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-preprocessor">#define</span> _CRT_SECURE_NO_WARNINGS

<span class="highlight-preprocessor">#include</span> <span class="highlight-literal">&lt;atlbase.h&gt;</span>
<span class="highlight-preprocessor">#include</span> <span class="highlight-literal">&lt;atlstr.h&gt;</span>
<span class="highlight-preprocessor">#include</span> <span class="highlight-literal">&lt;atlsafe.h&gt;</span>
<span class="highlight-preprocessor">#include</span> <span class="highlight-literal">&lt;iostream&gt;</span>
<span class="highlight-preprocessor">#include</span> <span class="highlight-literal">&lt;iomanip&gt;</span>

<span class="highlight-preprocessor">#import</span> <span class="highlight-literal">"ETABSv1.tlb"</span>  no_dual_interfaces rename(<span class="highlight-literal">"GetObject"</span>, <span class="highlight-literal">"GetObject_"</span>) rename(<span class="highlight-literal">"Yield"</span>, <span class="highlight-literal">"Yield_"</span>) rename(<span class="highlight-literal">"GetProp"</span>, <span class="highlight-literal">"GetProp_"</span>) rename(<span class="highlight-literal">"SetProp"</span>, <span class="highlight-literal">"SetProp_"</span>)

<span class="highlight-keyword">bool</span> CheckHRESULT(HRESULT hRes, <span class="highlight-keyword">const</span> <span class="highlight-keyword">wchar_t</span>* msg)
{
    <span class="highlight-keyword">if</span> (hRes == S_FALSE || FAILED(hRes)) {
        MessageBox(<span class="highlight-number">0</span>, msg, L<span class="highlight-literal">"ERROR!"</span>, MB_SETFOREGROUND);
        <span class="highlight-keyword">return</span> (<span class="highlight-keyword">false</span>);
    }
    <span class="highlight-keyword">return</span> (<span class="highlight-keyword">true</span>);
}

<span class="highlight-keyword">int</span> main(<span class="highlight-keyword">int</span> argc, <span class="highlight-keyword">char</span>* argv[])
{
    ::SetConsoleOutputCP(CP_UTF8);

    <span class="highlight-comment">// set the following flag to true to attach to an existing instance of the program</span>
<span class="highlight-comment">// otherwise a new instance of the program will be started</span>
    <span class="highlight-keyword">bool</span> bAttachToInstance = <span class="highlight-keyword">false</span>;

    <span class="highlight-comment">// set the following flag to true to manually specify the path to ETABS.exe</span>
    <span class="highlight-comment">// this allows for a connection to a version of ETABS other than the latest installation</span>
    <span class="highlight-comment">// otherwise the latest installed version of ETABS will be launched</span>
    <span class="highlight-keyword">bool</span> bSpecifyPath = <span class="highlight-keyword">false</span>;

    <span class="highlight-comment">// if the above flag is set to true, specify the path to ETABS below</span>
    std::wstring ProgramPath;

    <span class="highlight-keyword">int</span> mode = <span class="highlight-number">1</span>;

    <span class="highlight-comment">//1- start</span>
    <span class="highlight-comment">//2- start from path</span>
    <span class="highlight-comment">//3- attach</span>

    <span class="highlight-keyword">switch</span> (argc)
    {
    <span class="highlight-keyword">case</span> <span class="highlight-number">1</span>: <span class="highlight-comment">// no arguments - mode start</span>
        bAttachToInstance = <span class="highlight-keyword">false</span>;
        bSpecifyPath = <span class="highlight-keyword">false</span>;
        <span class="highlight-keyword">break</span>;

    <span class="highlight-keyword">case</span> <span class="highlight-number">2</span>: <span class="highlight-comment">// one argument - mode attach</span>
        bAttachToInstance = <span class="highlight-keyword">true</span>;
        <span class="highlight-keyword">break</span>;

    <span class="highlight-keyword">case</span> <span class="highlight-number">3</span>: <span class="highlight-comment">// two argument - mode start from path</span>
        bAttachToInstance = <span class="highlight-keyword">false</span>;
        bSpecifyPath = <span class="highlight-keyword">true</span>;

        <span class="highlight-keyword">char</span>* p = argv[<span class="highlight-number">2</span>];
        <span class="highlight-keyword">const</span> size_t cSize = strlen(p) + <span class="highlight-number">1</span>;
        std::wstring wc(cSize, L<span class="highlight-literal">'#'</span>);
        mbstowcs(&amp;wc[<span class="highlight-number">0</span>], p, cSize);
        ProgramPath = wc;
        <span class="highlight-keyword">break</span>;
    }

    <span class="highlight-comment">// use res to check if functions return successfully (res = 0) or fail (res = nonzero)</span>
    HRESULT hRes = <span class="highlight-number">0</span>;
    <span class="highlight-keyword">int</span> res = <span class="highlight-number">0</span>;

    <span class="highlight-comment">// initialize COM</span>
    hRes = CoInitialize(NULL);
    <span class="highlight-keyword">if</span> (!CheckHRESULT(hRes, L<span class="highlight-literal">"Error initializing COM subsystem!"</span>)) <span class="highlight-keyword">return</span> (hRes);

    <span class="highlight-comment">// ETABSObject pointer</span>
    CComPtr&lt;ETABSv1::cOAPI&gt; pETABSObject;

    <span class="highlight-keyword">try</span> {

        <span class="highlight-comment">// create Helper</span>
        CComPtr&lt;ETABSv1::cHelper&gt; pHelper;
        hRes = pHelper.CoCreateInstance(L<span class="highlight-literal">"ETABSv1.Helper"</span>, NULL, CLSCTX_INPROC_SERVER);
        <span class="highlight-keyword">if</span> (!CheckHRESULT(hRes, L<span class="highlight-literal">"Cannot instantiate helper!"</span>)) <span class="highlight-keyword">return</span> (hRes);

        <span class="highlight-keyword">if</span> (bAttachToInstance) {

            <span class="highlight-comment">// attach to a running instance of ETABS</span>

            <span class="highlight-comment">// get the active ETABS object</span>
            pETABSObject = pHelper-&gt;GetObject_(L<span class="highlight-literal">"CSI.ETABS.API.ETABSObject"</span>);
            hRes = ((pETABSObject) ? S_OK : S_FALSE);
            <span class="highlight-keyword">if</span> (!CheckHRESULT(hRes, L<span class="highlight-literal">"Cannot attach to ETABSObject!"</span>)) <span class="highlight-keyword">return</span> (hRes);
        }
        <span class="highlight-keyword">else</span> {
            <span class="highlight-comment">// start a new instance of ETABS</span>

            <span class="highlight-keyword">if</span> (bSpecifyPath) {
                <span class="highlight-comment">// create an instance of the ETABS object from the specified path</span>
                pETABSObject = pHelper-&gt;CreateObject(ProgramPath.c_str());
                hRes = ((pETABSObject) ? S_OK : S_FALSE);
                <span class="highlight-keyword">if</span> (!CheckHRESULT(hRes, L<span class="highlight-literal">"Cannot instantiate ETABSObject!"</span>)) <span class="highlight-keyword">return</span> (hRes);
            }
            <span class="highlight-keyword">else</span> {
                <span class="highlight-comment">// create an instance of the ETABS object from the latest installed ETABS</span>
                pETABSObject = pHelper-&gt;CreateObjectProgID(L<span class="highlight-literal">"CSI.ETABS.API.ETABSObject"</span>);
                hRes = ((pETABSObject) ? S_OK : S_FALSE);
                <span class="highlight-keyword">if</span> (!CheckHRESULT(hRes, L<span class="highlight-literal">"Cannot instantiate ETABSObject!"</span>)) <span class="highlight-keyword">return</span> (hRes);
            }

            <span class="highlight-keyword">double</span> ver = pETABSObject-&gt;GetOAPIVersionNumber();
            <span class="highlight-comment">// start ETABS application</span>
            res = pETABSObject-&gt;ApplicationStart();
            <span class="highlight-keyword">if</span> (!CheckHRESULT(hRes, L<span class="highlight-literal">"ETABSObject.ApplicationStart failed!"</span>)) <span class="highlight-keyword">return</span> (hRes);
        }

        <span class="highlight-comment">// initialize model</span>
        res = pETABSObject-&gt;SapModel-&gt;InitializeNewModel(ETABSv1::eUnits_kip_in_F);

        <span class="highlight-comment">// create steel deck template model</span>
        res = pETABSObject-&gt;SapModel-&gt;File-&gt;NewSteelDeck(<span class="highlight-number">4</span>, <span class="highlight-number">12</span>, <span class="highlight-number">12</span>, <span class="highlight-number">4</span>, <span class="highlight-number">4</span>, <span class="highlight-number">24</span>, <span class="highlight-number">24</span>);

        <span class="highlight-comment">// save model;</span>
        CreateDirectory(L<span class="highlight-literal">"C:\\CSi_ETABS_API_example\\"</span>, NULL);
        res = pETABSObject-&gt;SapModel-&gt;File-&gt;Save(L<span class="highlight-literal">"C:\\CSi_ETABS_API_example\\example.edb"</span>);

        <span class="highlight-comment">// run model (this will create the analysis model)</span>
        res = pETABSObject-&gt;SapModel-&gt;Analyze-&gt;RunAnalysis();

        <span class="highlight-comment">// clear all case and combo output selections</span>
        res = pETABSObject-&gt;SapModel-&gt;Results-&gt;Setup-&gt;DeselectAllCasesAndCombosForOutput();

        <span class="highlight-comment">// set case and combo output selections</span>
        res = pETABSObject-&gt;SapModel-&gt;Results-&gt;Setup-&gt;SetCaseSelectedForOutput(<span class="highlight-literal">"DEAD"</span>, VARIANT_TRUE);

        <span class="highlight-comment">// get frame forces for all frame objects</span>
        <span class="highlight-keyword">long</span> NumberResults;
        CComSafeArray<span class="highlight-literal">&lt;BSTR&gt;</span> Obj(<span class="highlight-number">1</span>);
        Obj[<span class="highlight-number">0</span>] = ::SysAllocString(L<span class="highlight-literal">""</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> ObjSta(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;BSTR&gt;</span> Elm(<span class="highlight-number">1</span>);
        Elm[<span class="highlight-number">0</span>] = ::SysAllocString(L<span class="highlight-literal">""</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> ElmSta(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;BSTR&gt;</span> LoadCase(<span class="highlight-number">1</span>);
        LoadCase[<span class="highlight-number">0</span>] = ::SysAllocString(L<span class="highlight-literal">""</span>);
        CComSafeArray<span class="highlight-literal">&lt;BSTR&gt;</span> StepType(<span class="highlight-number">1</span>);
        StepType[<span class="highlight-number">0</span>] = ::SysAllocString(L<span class="highlight-literal">""</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> StepNum(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> P(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> V2(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> V3(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> T(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> M2(<span class="highlight-number">1</span>);
        CComSafeArray<span class="highlight-literal">&lt;double&gt;</span> M3(<span class="highlight-number">1</span>);

        LPSAFEARRAY pObj = Obj.Detach();
        LPSAFEARRAY pObjSta = ObjSta.Detach();
        LPSAFEARRAY pElm = Elm.Detach();
        LPSAFEARRAY pElmSta = ElmSta.Detach();
        LPSAFEARRAY pLoadCase = LoadCase.Detach();
        LPSAFEARRAY pStepType = StepType.Detach();
        LPSAFEARRAY pStepNum = StepNum.Detach();
        LPSAFEARRAY pP = P.Detach();
        LPSAFEARRAY pV2 = V2.Detach();
        LPSAFEARRAY pV3 = V3.Detach();
        LPSAFEARRAY pT = T.Detach();
        LPSAFEARRAY pM2 = M2.Detach();
        LPSAFEARRAY pM3 = M3.Detach();

        res = pETABSObject-&gt;SapModel-&gt;Results-&gt;FrameForce(<span class="highlight-literal">"All"</span>, ETABSv1::eItemTypeElm_GroupElm, &amp;NumberResults, &amp;pObj, &amp;pObjSta, &amp;pElm, &amp;pElmSta, &amp;pLoadCase, &amp;pStepType, &amp;pStepNum, &amp;pP, &amp;pV2, &amp;pV3, &amp;pT, &amp;pM2, &amp;pM3);

        Obj.Attach(pObj);
        ObjSta.Attach(pObjSta);
        Elm.Attach(pElm);
        ElmSta.Attach(pElmSta);
        LoadCase.Attach(pLoadCase);
        StepType.Attach(pStepType);
        StepNum.Attach(pStepNum);
        P.Attach(pP);
        V2.Attach(pV2);
        V3.Attach(pV3);
        T.Attach(pT);
        M2.Attach(pM2);
        M3.Attach(pM3);

        <span class="highlight-comment">// close ETABS</span>
        CComVariant vFalse(<span class="highlight-keyword">false</span>);
        res = pETABSObject-&gt;ApplicationExit(<span class="highlight-keyword">false</span>);

        <span class="highlight-comment">// uninitialize COM</span>
        CoUninitialize();

        <span class="highlight-comment">// we're done!</span>
        <span class="highlight-keyword">return</span> (res);
    }
    <span class="highlight-keyword">catch</span> (_com_error&amp; ex) {
        CheckHRESULT(ex.Error(), ex.ErrorMessage());

        <span class="highlight-comment">// close ETABS</span>
        CComVariant vRes = pETABSObject-&gt;ApplicationExit(<span class="highlight-keyword">false</span>);

        <span class="highlight-comment">// uninitialize COM</span>
        CoUninitialize();

        <span class="highlight-keyword">return</span> (<span class="highlight-number">-1</span>);
    }

    <span class="highlight-keyword">return</span> EXIT_SUCCESS;
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAABGAAA");</script></li></ol></div></div></div><div id="pageFooter" class="pageFooter">ETABS®, SAFE®, SAP2000® and CSiBridge® are registered trademarks of Computers and Structures, Inc.<br /><p><a href="https://www.csiamerica.com" target="_blank" rel="noopener noreferrer">Copyright © Computers and Structures, Inc. 2024. All rights reserved.</a></p><div class="feedbackLink">Send comments on this topic to
        <a id="HT_MailLink" href="mailto:support%40csiamerica.com?Subject=CSI%20API%20ETABS%20v1">support@csiamerica.com</a></div>
        <script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>