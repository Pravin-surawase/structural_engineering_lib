# v0.7 Data Mapping Specification

**Agent:** INTEGRATION
**Task:** TASK-029
**Status:** Complete
**Date:** 2025-12-11

---

## 1. Overview

This document defines the data flow from Excel tables to DXF generation for beam detailing drawings.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DATA FLOW DIAGRAM                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌───────────┐ │
│  │ BEAM_INPUT   │───▶│ BEAM_DESIGN  │───▶│   Detailing  │───▶│    DXF    │ │
│  │ (tbl_BeamInput)   │(tbl_BeamDesign)   │   Module     │    │   File    │ │
│  └──────────────┘    └──────────────┘    └──────────────┘    └───────────┘ │
│                                                                             │
│  User Input +        FlexureResult +      Development      Beam Elevation   │
│  ETABS Import        ShearResult          Lap, Spacing     + Section Views  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Source Tables

### 2.1 tbl_BeamInput (BEAM_INPUT Sheet)

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| BeamID | String | Unique beam identifier | "B1" |
| Story | String | Floor level | "Story1" |
| b | Double | Width (mm) | 300 |
| D | Double | Overall depth (mm) | 500 |
| d | Double | Effective depth (mm) | 460 |
| Span | Double | Clear span (mm) | 4000 |
| Cover | Double | Clear cover (mm) | 40 |
| fck | Double | Concrete grade (N/mm²) | 25 |
| fy | Double | Steel grade (N/mm²) | 500 |
| Mu | Double | Design moment (kN-m) | 150 |
| Vu | Double | Design shear (kN) | 100 |

### 2.2 tbl_BeamDesign (BEAM_DESIGN Sheet)

| Column | Type | Description | Source |
|--------|------|-------------|--------|
| BeamID | String | Beam identifier | Input |
| Story | String | Floor level | Input |
| b, D, d, Span | Double | Geometry | Input |
| fck, fy | Double | Material grades | Input |
| Mu, Vu | Double | Design forces | Input |
| Mu_Lim | Double | Limiting moment (kN-m) | FlexureResult |
| Ast_req | Double | Tension steel (mm²) | FlexureResult |
| Asc_req | Double | Compression steel (mm²) | FlexureResult |
| Xu | Double | Neutral axis depth (mm) | FlexureResult |
| SectionType | String | Under/Balanced/Over | FlexureResult |
| Tv | Double | Shear stress (N/mm²) | ShearResult |
| Tc | Double | Concrete shear capacity | ShearResult |
| Stirrup_Dia | Integer | Stirrup diameter (mm) | ShearResult |
| Stirrup_Spacing | Double | Stirrup spacing (mm) | ShearResult |
| Status | String | Design status | "OK"/"REVISE" |

---

## 3. Mapping to Detailing Module

### 3.1 Input Parameters for `create_beam_detailing()`

```python
def create_beam_detailing(
    beam_id: str,          # ← tbl_BeamDesign.BeamID
    story: str,            # ← tbl_BeamDesign.Story
    b: float,              # ← tbl_BeamDesign.b
    D: float,              # ← tbl_BeamDesign.D
    span: float,           # ← tbl_BeamDesign.Span
    cover: float,          # ← tbl_BeamDesign.Cover (default 40)
    fck: float,            # ← tbl_BeamDesign.fck
    fy: float,             # ← tbl_BeamDesign.fy
    ast_required: float,   # ← tbl_BeamDesign.Ast_req
    asc_required: float,   # ← tbl_BeamDesign.Asc_req
    sv: float,             # ← tbl_BeamDesign.Stirrup_Spacing
    stirrup_dia: float,    # ← tbl_BeamDesign.Stirrup_Dia
    is_seismic: bool       # ← User preference (default False)
) -> BeamDetailingResult
```

### 3.2 Field Mapping Table

| Detailing Input | Source Column | Notes |
|-----------------|---------------|-------|
| `beam_id` | BeamID | Direct |
| `story` | Story | Direct |
| `b` | b | mm |
| `D` | D | mm |
| `span` | Span | mm |
| `cover` | Cover | Default 40 if missing |
| `fck` | fck | N/mm² (use integer for lookup) |
| `fy` | fy | N/mm² |
| `ast_required` | Ast_req | mm² from flexure |
| `asc_required` | Asc_req | mm² (0 for singly reinforced) |
| `sv` | Stirrup_Spacing | mm |
| `stirrup_dia` | Stirrup_Dia | mm |
| `is_seismic` | (derived) | Check if IS 13920 applies |

---

## 4. Output: BeamDetailingResult Structure

```python
@dataclass
class BeamDetailingResult:
    # Identification
    beam_id: str          # "B1"
    story: str            # "Story1"

    # Geometry (mm)
    b: float              # 300
    D: float              # 500
    span: float           # 4000
    cover: float          # 40

    # Reinforcement arrangements
    top_bars: List[BarArrangement]     # [start, mid, end]
    bottom_bars: List[BarArrangement]  # [start, mid, end]
    stirrups: List[StirrupArrangement] # [start, mid, end]

    # Detailing values
    ld_tension: float      # Development length (mm)
    ld_compression: float  # Compression Ld (mm)
    lap_length: float      # Lap splice length (mm)

    # Status
    is_valid: bool
    remarks: str
```

---

## 5. DXF Export Data Flow

### 5.1 Input to `generate_beam_dxf()`

```python
def generate_beam_dxf(
    result: BeamDetailingResult,  # ← From detailing module
    output_path: str,             # ← User specified path
    scale: float = 1.0,           # ← Drawing scale (default 1:1)
    include_section: bool = True  # ← Include cross-section view
)
```

### 5.2 DXF Layer Mapping

| Layer Name | Color | Content |
|------------|-------|---------|
| BEAM_OUTLINE | White (7) | Beam perimeter |
| REBAR_MAIN | Red (1) | Main bars (top/bottom) |
| REBAR_STIRRUP | Green (3) | Stirrup outlines |
| DIMENSIONS | Cyan (4) | Dimension lines |
| TEXT | Yellow (2) | Callouts, labels |
| CENTERLINE | Magenta (6) | CL lines |

Contract reference: `docs/reference/bbs-dxf-contract.md`

---

## 6. Integration Code Pattern

### 6.1 Python Integration (Recommended)

```python
from structural_lib.detailing import create_beam_detailing
from structural_lib.dxf_export import generate_beam_dxf

def process_beam_for_dxf(row_data: dict, output_folder: str):
    """
    Process a single beam design row and generate DXF.

    Args:
        row_data: Dictionary with tbl_BeamDesign column values
        output_folder: Path to save DXF files
    """
    # 1. Create detailing from design data
    detailing = create_beam_detailing(
        beam_id=row_data["BeamID"],
        story=row_data["Story"],
        b=float(row_data["b"]),
        D=float(row_data["D"]),
        span=float(row_data["Span"]),
        cover=float(row_data.get("Cover", 40)),
        fck=float(row_data["fck"]),
        fy=float(row_data["fy"]),
        ast_required=float(row_data["Ast_req"]),
        asc_required=float(row_data.get("Asc_req", 0)),
        sv=float(row_data["Stirrup_Spacing"]),
        stirrup_dia=float(row_data["Stirrup_Dia"]),
        is_seismic=False
    )

    # 2. Generate DXF
    filename = f"{row_data['Story']}_{row_data['BeamID']}_detail.dxf"
    output_path = f"{output_folder}/{filename}"

    generate_beam_dxf(detailing, output_path)

    return output_path
```

### 6.2 VBA Integration (Optional)

```vba
' Call Python via shell for DXF generation
Sub Generate_DXF_For_Beam(beamId As String)
    Dim pyScript As String
    Dim jsonPath As String
    Dim dxfPath As String

    ' Export beam data to JSON
    jsonPath = ExportBeamToJSON(beamId)
    dxfPath = ThisWorkbook.Path & "\beam_" & beamId & ".dxf"

    ' Call Python script
    pyScript = "python -m structural_lib dxf " & jsonPath & " -o " & dxfPath
    Shell pyScript, vbNormalFocus
End Sub
```

---

## 7. Validation Rules

### 7.1 Input Validation

| Field | Rule | Error |
|-------|------|-------|
| b | > 0 | "Invalid beam width" |
| D | > 0, > b/4 | "Invalid beam depth" |
| span | > 0, > D | "Invalid span" |
| cover | 20-75 mm | "Cover out of range" |
| fck | 15-50, in table | "Invalid concrete grade" |
| fy | 250, 415, 500, 550 | "Invalid steel grade" |
| Ast_req | > 0 | "No tension steel calculated" |

### 7.2 Output Validation

| Check | Rule | Action |
|-------|------|--------|
| Bar spacing | ≥ max(bar_dia, 25, agg+5) | Warning if violated |
| Min bars | ≥ 2 | Error if < 2 |
| Max bars/layer | Fit in width | Split to layers |
| Ld vs Span | Ld < span/4 | Warning if anchoring issue |

---

## 8. Example Data Flow

**Input (from tbl_BeamDesign):**
```
BeamID: B1
Story: Story1
b: 300, D: 500, Span: 4000, Cover: 40
fck: 25, fy: 500
Ast_req: 942.5, Asc_req: 0
Stirrup_Spacing: 150, Stirrup_Dia: 8
```

**Detailing Output:**
```
Bottom: 3-20φ (As=942.5 mm²)
Top: 2-12φ (hanger bars)
Stirrups: 2L-8φ@150 (both ends), 2L-8φ@200 (mid)
Ld (tension): 904 mm
Lap length: 1357 mm
```

**DXF Output:**
- File: `Story1_B1_detail.dxf`
- Views: Elevation + Section
- Callouts: "3-20φ BOT", "2-12φ TOP", "2L-8φ@150 c/c"

---

## 9. Sign-Off

| Role | Status | Date |
|------|--------|------|
| INTEGRATION Agent | ✅ Approved | 2025-12-11 |
| DEV Agent | ⏳ Pending review | |
| TESTER Agent | ⏳ Pending tests | |

---

*Document: v0.7_DATA_MAPPING.md*
*Version: 1.0*
