# Streamlit App Validation Workflow
# Runs comprehensive checks on Streamlit app code to catch runtime errors before deployment
name: Streamlit Validation

on:
  push:
    branches: [main]
    paths:
      - 'streamlit_app/**/*.py'
      - 'tests/apptest/**/*.py'
      - 'scripts/check_streamlit_issues.py'
      - 'scripts/check_fragment_violations.py'
      - '.pylintrc-streamlit'
      - '.github/workflows/streamlit-validation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'streamlit_app/**/*.py'
      - 'tests/apptest/**/*.py'
      - 'scripts/check_streamlit_issues.py'
      - 'scripts/check_fragment_violations.py'
      - '.pylintrc-streamlit'

jobs:
  fragment-validator:
    name: Fragment API Validator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Run Fragment API Validator
        run: |
          python scripts/check_fragment_violations.py

      - name: Check for violations
        run: |
          EXIT_CODE=$(python scripts/check_fragment_violations.py; echo $?)
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Fragment API violations found"
            exit 1
          fi
          echo "âœ… No fragment API violations"

  ast-scanner:
    name: AST Scanner (NameError, ZeroDivisionError, etc.)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install streamlit pandas numpy plotly pyyaml

      - name: Run AST Scanner (all pages)
        run: |
          python scripts/check_streamlit_issues.py --all-pages --verbose

      - name: Check for critical issues
        run: |
          # Fail if any critical issues found
          python scripts/check_streamlit_issues.py --all-pages --fail-on-critical

  pylint-check:
    name: Pylint (undefined variables, imports, etc.)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint streamlit pandas numpy plotly pyyaml

      - name: Run Pylint
        run: |
          python -m pylint --rcfile=.pylintrc-streamlit streamlit_app/pages/*.py || true

      - name: Check for errors
        run: |
          # Exit code 0-3 = warnings/refactoring, 4-31 = errors
          EXIT_CODE=$(python -m pylint --rcfile=.pylintrc-streamlit streamlit_app/pages/*.py; echo $?)
          if [ $EXIT_CODE -ge 4 ]; then
            echo "âŒ Pylint found errors (exit code: $EXIT_CODE)"
            exit 1
          fi
          echo "âœ“ Pylint check passed"

  critical-journeys:
    name: Critical Journeys (pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            Python/pyproject.toml
            streamlit_app/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r streamlit_app/requirements.txt
          python -m pip install -e "./Python[dev,dxf]"

      - name: Run critical journey tests
        run: |
          python -m pytest -q streamlit_app/tests/test_critical_journeys.py

  apptest-smoke:
    name: AppTest Smoke Tests (29 tests)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            Python/pyproject.toml
            streamlit_app/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r streamlit_app/requirements.txt
          python -m pip install -e "./Python[dev,dxf]"

      - name: Run AppTest smoke tests
        run: |
          python -m pytest tests/apptest/ -v --tb=short

      - name: Summary
        if: always()
        run: |
          echo "âœ… AppTest tests verify all 12 Streamlit pages load without exceptions"
          echo "   - Smoke tests: All pages render correctly"
          echo "   - Beam design: Widget interaction and calculations work"

  api-signature-check:
    name: API Signature Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Run API Signature Checker
        run: |
          python scripts/check_api_signatures.py --fix

      - name: Verify no signature issues
        run: |
          EXIT_CODE=$(python scripts/check_api_signatures.py; echo $?)
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ API signature issues found"
            exit 1
          fi
          echo "âœ… All API signatures valid"

  combined-report:
    name: Combined Analysis Report
    runs-on: ubuntu-latest
    needs: [fragment-validator, ast-scanner, pylint-check, critical-journeys, apptest-smoke, api-signature-check]
    if: always()
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint streamlit pandas numpy plotly pyyaml

      - name: Generate Combined Report
        run: |
          echo "# Streamlit Validation Report" > report.md
          echo "" >> report.md
          echo "## AST Scanner Results" >> report.md
          python scripts/check_streamlit_issues.py --all-pages --verbose >> report.md 2>&1 || true
          echo "" >> report.md
          echo "## API Signature Results" >> report.md
          python scripts/check_api_signatures.py --fix >> report.md 2>&1 || true
          echo "" >> report.md
          echo "## Pylint Results" >> report.md
          python -m pylint --rcfile=.pylintrc-streamlit streamlit_app/pages/*.py >> report.md 2>&1 || true

      - name: Upload Report
        uses: actions/upload-artifact@v6
        with:
          name: streamlit-validation-report
          path: report.md
          retention-days: 30

      - name: Display Summary
        run: |
          echo "ðŸ“Š Validation Summary:"
          echo "Fragment API: ${{ needs.fragment-validator.result }}"
          echo "AST Scanner: ${{ needs.ast-scanner.result }}"
          echo "API Signatures: ${{ needs.api-signature-check.result }}"
          echo "Pylint: ${{ needs.pylint-check.result }}"
          echo "Critical journeys: ${{ needs.critical-journeys.result }}"
          echo "AppTest smoke: ${{ needs.apptest-smoke.result }}"
