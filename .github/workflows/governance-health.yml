name: Governance Health Check

# Agent 9 Governance - TASK-289
# Purpose: Weekly comprehensive governance health assessment
# Runs: Weekly on Sundays, on demand, or on main branch changes to governance scripts

on:
  schedule:
    # Run weekly on Sunday at 8 AM UTC
    - cron: '0 8 * * 0'
  workflow_dispatch:
    inputs:
      save_metrics:
        description: 'Save metrics to file'
        type: boolean
        default: true
  push:
    branches: [main]
    paths:
      - 'scripts/predict_velocity.py'
      - 'scripts/governance_health_score.py'
      - 'scripts/analyze_release_cadence.py'
      - 'scripts/collect_metrics.sh'

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Governance Health Assessment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Governance Health Score
        id: health
        run: |
          python scripts/governance_health_score.py --json > /tmp/health.json 2>&1 || true

          # Also run human-readable version for logs
          echo "=== GOVERNANCE HEALTH REPORT ==="
          python scripts/governance_health_score.py || true

          # Extract key metrics
          if [ -f /tmp/health.json ]; then
            SCORE=$(python -c "import json; d=json.load(open('/tmp/health.json')); print(d.get('score', 0))")
            GRADE=$(python -c "import json; d=json.load(open('/tmp/health.json')); print(d.get('grade', 'N/A'))")
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "grade=$GRADE" >> $GITHUB_OUTPUT
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "grade=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Run Velocity Prediction
        id: velocity
        run: |
          echo "=== VELOCITY PREDICTION ==="
          python scripts/predict_velocity.py || true

      - name: Run Release Cadence Analysis
        id: cadence
        run: |
          echo "=== RELEASE CADENCE ANALYSIS ==="
          python scripts/analyze_release_cadence.py || true

      - name: Summary Report
        run: |
          echo "## üìä Governance Health Summary"
          echo ""
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| Health Score | ${{ steps.health.outputs.score }}/100 |"
          echo "| Grade | ${{ steps.health.outputs.grade }} |"
          echo ""
          echo "View full reports in the Actions log above."

      - name: Check for critical issues
        run: |
          SCORE=${{ steps.health.outputs.score }}
          if [ "$SCORE" -lt 50 ]; then
            echo "‚ö†Ô∏è WARNING: Governance health score is critically low ($SCORE/100)"
            echo "Action required: Run ./scripts/governance_health_score.py for recommendations"
          elif [ "$SCORE" -lt 70 ]; then
            echo "‚ö†Ô∏è NOTICE: Governance health could be improved ($SCORE/100)"
          else
            echo "‚úÖ Governance health is good ($SCORE/100)"
          fi
