# OpenSSF Scorecard Security Assessment
#
# Runs automated security checks to assess supply-chain security posture.
# Results are uploaded to GitHub Security tab and as workflow artifacts.
#
# Standards alignment:
# - OpenSSF Scorecard (https://securityscorecards.dev)
# - SLSA Supply Chain Security
# - NIST SSDF (SP 800-218)
#
# Created: 2026-01-24 (Session 69)
# Reference: https://github.com/ossf/scorecard-action

name: OpenSSF Scorecard

on:
  # Run on push to main for continuous monitoring
  push:
    branches: [ main ]
  # Run weekly for baseline tracking
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC
  # Allow manual trigger for ad-hoc assessment
  workflow_dispatch:

# Required permissions for Scorecard
permissions:
  # Needed to upload results to code-scanning dashboard
  security-events: write
  # Needed to read repository contents
  contents: read
  # Needed for dependency graph
  actions: read
  # Needed for OIDC token (Scorecard publishing)
  id-token: write

jobs:
  scorecard-analysis:
    name: Scorecard Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@v2.4.3
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          # Publish results to OpenSSF REST API
          # (requires repo to be public or SCORECARD_TOKEN secret)
          publish_results: true

      - name: Upload Scorecard SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: scorecard-results.sarif

      - name: Upload Scorecard results as artifact
        uses: actions/upload-artifact@v6
        with:
          name: scorecard-results
          path: scorecard-results.sarif
          retention-days: 90

  # Generate human-readable summary
  scorecard-summary:
    name: Scorecard Summary
    runs-on: ubuntu-latest
    needs: scorecard-analysis
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Scorecard results
        uses: actions/download-artifact@v7
        with:
          name: scorecard-results
          path: .
        continue-on-error: true

      - name: Parse and display summary
        run: |
          echo "üìä OpenSSF Scorecard Summary"
          echo "============================"
          echo ""

          if [ -f scorecard-results.sarif ]; then
            # Extract key scores from SARIF
            python3 -c "
          import json
          import sys

          try:
              with open('scorecard-results.sarif') as f:
                  data = json.load(f)

              runs = data.get('runs', [])
              if not runs:
                  print('‚ö†Ô∏è No scorecard results found')
                  sys.exit(0)

              results = runs[0].get('results', [])
              print(f'Total checks: {len(results)}')
              print()

              # Group by severity
              high = [r for r in results if r.get('level') == 'error']
              medium = [r for r in results if r.get('level') == 'warning']
              low = [r for r in results if r.get('level') == 'note']

              print(f'üî¥ High severity issues: {len(high)}')
              print(f'üü° Medium severity issues: {len(medium)}')
              print(f'üü¢ Low/info issues: {len(low)}')
              print()

              # Show high severity details
              if high:
                  print('High Severity Issues:')
                  for r in high[:5]:  # First 5
                      rule = r.get('ruleId', 'unknown')
                      msg = r.get('message', {}).get('text', 'No details')[:100]
                      print(f'  - {rule}: {msg}')
                  if len(high) > 5:
                      print(f'  ... and {len(high) - 5} more')

          except Exception as e:
              print(f'Error parsing results: {e}')
          "
          else
            echo "‚ö†Ô∏è No scorecard results file found"
            echo "   This may be the first run or results are still processing"
          fi

      - name: Create summary badge data
        run: |
          # Create JSON for potential badge generation
          if [ -f scorecard-results.sarif ]; then
            python3 -c "
          import json
          from datetime import datetime, timezone

          with open('scorecard-results.sarif') as f:
              data = json.load(f)

          runs = data.get('runs', [])
          results = runs[0].get('results', []) if runs else []

          high = len([r for r in results if r.get('level') == 'error'])
          medium = len([r for r in results if r.get('level') == 'warning'])

          badge = {
              'schemaVersion': 1,
              'label': 'OpenSSF Scorecard',
              'message': f'{len(results)} checks',
              'color': 'green' if high == 0 else ('yellow' if high <= 2 else 'red'),
              'generated': datetime.now(timezone.utc).isoformat()
          }

          with open('scorecard-badge.json', 'w') as f:
              json.dump(badge, f, indent=2)

          print('Badge data generated')
          "
          fi

      - name: Security posture summary
        run: |
          echo ""
          echo "üìã Next Steps"
          echo "============="
          echo "1. View detailed results in GitHub Security tab"
          echo "2. Address high severity issues first"
          echo "3. Review scorecard-results.sarif artifact for full details"
          echo ""
          echo "Documentation: https://securityscorecards.dev/"
          echo "Scorecard repository: https://github.com/ossf/scorecard"
