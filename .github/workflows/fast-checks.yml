name: Fast PR Checks

on:
  pull_request:
  push:
    branches: [ main ]

# Quick checks for PRs - run only essential validations
# Full test matrix runs after merge to main
#
# EFFICIENCY OPTIMIZATION (added 2026-01-24):
# - Uses dorny/paths-filter to detect what changed
# - Docs-only changes skip Python tests
# - Python changes skip doc checks (separate workflow)
# - Keeps PR feedback under 3-5 minutes

permissions:
  contents: read

jobs:
  # Detect what files changed to optimize job selection
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      docs: ${{ steps.filter.outputs.docs }}
      scripts: ${{ steps.filter.outputs.scripts }}
      streamlit: ${{ steps.filter.outputs.streamlit }}
      fastapi: ${{ steps.filter.outputs.fastapi }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'Python/**'
              - 'pyproject.toml'
              - 'setup.cfg'
            docs:
              - 'docs/**'
              - '*.md'
              - 'agents/**'
            scripts:
              - 'scripts/**'
            streamlit:
              - 'streamlit_app/**'
            fastapi:
              - 'fastapi_app/**'
              - 'requirements.txt'

  # Python validation - only when Python code changes
  python-validation:
    name: Python Validation
    needs: changes
    if: needs.changes.outputs.python == 'true' || needs.changes.outputs.streamlit == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: Python/pyproject.toml

      - name: Install package (dev)
        working-directory: Python
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Format check (black)
        working-directory: Python
        run: python -m black --check .

      - name: Lint check (ruff)
        working-directory: Python
        run: python -m ruff check .

      - name: Type check (mypy)
        working-directory: Python
        run: python -m mypy

      - name: Contract tests (breaking change detection)
        working-directory: Python
        run: python -m pytest tests/integration/test_contracts.py -m contract -v

      - name: Core tests (fast subset)
        working-directory: Python
        run: python -m pytest tests/integration/test_flexure_edges_additional.py tests/unit/test_shear.py tests/unit/test_detailing.py -v

      - name: Code quality checks
        run: |
          python scripts/check_type_annotations.py --fail-threshold 50 --json > /dev/null || \
            (echo "‚ùå Type annotation rate below 50%" && exit 1)
          python scripts/check_circular_imports.py || \
            (echo "‚ùå Circular imports detected" && exit 1)
          python scripts/check_performance_issues.py || true
          echo "‚úÖ Code quality checks passed"

      - name: Governance structure gate (stub-only root modules)
        run: |
          python scripts/check_governance.py --structure --json > /tmp/governance-structure.json
          echo "‚úÖ Governance structure gate passed"

  # FastAPI validation - only when FastAPI code changes
  fastapi-validation:
    name: FastAPI Validation
    needs: changes
    if: needs.changes.outputs.fastapi == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: Python/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e "Python/[dev]"
          python -m pip install fastapi uvicorn httpx websockets sse-starlette python-jose[cryptography] pytest-asyncio python-multipart

      - name: Format check (black)
        run: python -m black --check fastapi_app/

      - name: Lint check (ruff)
        run: python -m ruff check fastapi_app/

      - name: Type check (mypy)
        run: python -m mypy fastapi_app/ --ignore-missing-imports || echo "‚ö†Ô∏è mypy has warnings (non-blocking)"

      - name: Run FastAPI tests
        run: python -m pytest fastapi_app/tests/ -v --tb=short

      - name: Security checks
        run: |
          python -m bandit -r fastapi_app/ -ll || true
          echo "‚úÖ FastAPI security scan complete"

      - name: API contract tests
        run: |
          if [ -f "scripts/validate_api_contracts.py" ]; then
            python scripts/validate_api_contracts.py || true
          fi
          echo "‚úÖ FastAPI validation passed"

      - name: API performance benchmarks
        run: |
          python scripts/benchmark_api.py --quick --threshold 50
          echo "‚úÖ FastAPI performance benchmarks passed"

  # Doc validation - only when docs change
  docs-validation:
    name: Docs Validation
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Doc checks (parallel)
        run: |
          python scripts/check_doc_versions.py --ci &
          python scripts/check_tasks_format.py &
          python scripts/check_api.py --sync &
          python scripts/generate_api_manifest.py --check &
          python scripts/check_links.py &
          wait

      - name: Governance checks
        run: |
          python scripts/check_governance.py

  # Scripts validation - only when scripts change
  scripts-validation:
    name: Scripts Validation
    needs: changes
    if: needs.changes.outputs.scripts == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Scripts checks
        run: |
          python scripts/check_scripts_index.py

  # Always-run minimal check (for status reporting)
  quick-validation:
    name: Quick Validation (Python 3.11 only)
    needs: changes
    # Run if nothing specific triggered, or as a safety net
    if: |
      needs.changes.outputs.python != 'true' &&
      needs.changes.outputs.docs != 'true' &&
      needs.changes.outputs.scripts != 'true' &&
      needs.changes.outputs.streamlit != 'true' &&
      needs.changes.outputs.fastapi != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Minimal validation
        run: |
          echo "‚úÖ No code/docs changes detected"
          echo "üìù Running minimal checks..."
          # Just verify repo is healthy
          python --version
          test -f README.md
          echo "‚úÖ Minimal validation passed"

  full-tests-notification:
    name: Full Test Info
    runs-on: ubuntu-latest
    steps:
      - name: Info
        run: |
          echo "‚úÖ Quick checks passed!"
          echo "üìù Full test matrix (Python 3.11-3.12) will run after merge to main"
          echo "‚ö° This workflow optimizes PR feedback speed"
