name: Fast PR Checks

on:
  pull_request:
  push:
    branches: [ main ]

# Quick checks for PRs - run only essential validations
# Full test matrix runs after merge to main
permissions:
  contents: read

jobs:
  quick-validation:
    name: Quick Validation (Python 3.11 only)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: Python/pyproject.toml

      - name: Install package (dev)
        working-directory: Python
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Format check (black)
        working-directory: Python
        run: python -m black --check .

      - name: Lint check (ruff)
        working-directory: Python
        run: python -m ruff check .

      - name: Type check (mypy)
        working-directory: Python
        run: python -m mypy

      - name: Contract tests (breaking change detection)
        working-directory: Python
        run: python -m pytest tests/integration/test_contracts.py -m contract -v

      - name: Core tests (fast subset)
        working-directory: Python
        run: python -m pytest tests/integration/test_flexure_edges_additional.py tests/unit/test_shear.py tests/unit/test_detailing.py -v

      - name: Doc checks (parallel)
        run: |
          python scripts/check_doc_versions.py --ci &
          python scripts/check_tasks_format.py &
          python scripts/check_api_docs_sync.py &
          python scripts/generate_api_manifest.py --check &
          python scripts/check_scripts_index.py &
          python scripts/check_links.py &
          wait

      - name: Governance checks
        run: |
          python scripts/validate_folder_structure.py
          python scripts/check_governance_compliance.py

      - name: Code quality checks (Streamlit scanner suite)
        run: |
          # Type annotation audit (fail if <50% annotated)
          python scripts/check_type_annotations.py --fail-threshold 50 --json > /dev/null || \
            (echo "‚ùå Type annotation rate below 50%" && exit 1)
          # Circular import detection (fail on any cycles)
          python scripts/check_circular_imports.py || \
            (echo "‚ùå Circular imports detected" && exit 1)
          # Performance issues (warn only, don't fail)
          python scripts/check_performance_issues.py || true
          echo "‚úÖ Code quality checks passed"

  full-tests-notification:
    name: Full Test Info
    runs-on: ubuntu-latest
    steps:
      - name: Info
        run: |
          echo "‚úÖ Quick checks passed!"
          echo "üìù Full test matrix (Python 3.11-3.12) will run after merge to main"
          echo "‚ö° This workflow optimizes PR feedback speed"
