name: Git Workflow Tests

on:
  push:
    branches: [main]
    paths:
      - 'scripts/safe_push.sh'
      - 'scripts/ai_commit.sh'
      - 'scripts/create_task_pr.sh'
      - 'scripts/finish_task_pr.sh'
      - 'scripts/test_git_workflow.sh'
      - 'scripts/validate_git_state.sh'
      - '.github/workflows/git-workflow-tests.yml'
  pull_request:
    paths:
      - 'scripts/safe_push.sh'
      - 'scripts/ai_commit.sh'
      - 'scripts/create_task_pr.sh'
      - 'scripts/finish_task_pr.sh'
      - 'scripts/test_git_workflow.sh'
      - 'scripts/validate_git_state.sh'
      - '.github/workflows/git-workflow-tests.yml'

jobs:
  test-git-workflow:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Git
        run: |
          git config --global user.name "CI Test"
          git config --global user.email "ci@example.com"

      - name: Make scripts executable
        run: |
          chmod +x scripts/test_git_workflow.sh
          chmod +x scripts/validate_git_state.sh
          chmod +x scripts/safe_push.sh
          chmod +x scripts/ai_commit.sh

      - name: Validate script syntax
        run: |
          echo "Checking bash syntax..."
          bash -n scripts/safe_push.sh
          bash -n scripts/ai_commit.sh
          bash -n scripts/create_task_pr.sh
          bash -n scripts/finish_task_pr.sh
          bash -n scripts/validate_git_state.sh
          bash -n scripts/test_git_workflow.sh

      - name: Run git state validation
        run: |
          ./scripts/validate_git_state.sh

      - name: Run git workflow tests
        run: |
          ./scripts/test_git_workflow.sh --verbose

      - name: Test safe_push.sh help
        run: |
          ./scripts/safe_push.sh --help || echo "No help flag (OK)"

      - name: Test ai_commit.sh with clean tree
        run: |
          # Should exit cleanly with no changes
          ./scripts/ai_commit.sh "test" || true

      - name: Verify scripts don't modify git state
        run: |
          # After running tests, git should be in clean state
          git status --porcelain
          if [[ -n $(git status --porcelain) ]]; then
            echo "ERROR: Tests left uncommitted changes"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: git-workflow-test-results
          path: |
            scripts/test_git_workflow.sh
            scripts/validate_git_state.sh
